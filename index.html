<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Servi√ßo+ ‚Äî Guia colaborativo de servi√ßos locais (v3)</title>
  <style>
    :root{--accent:#007bff;--muted:#6b7280;--bg:#f7fafc}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:#0f1724}
    header{background:linear-gradient(90deg,#0366d6,#0056b3);color:#fff;padding:18px 16px;display:flex;align-items:center;gap:12px}
    header h1{font-size:18px;margin:0}
    .container{max-width:980px;margin:20px auto;padding:16px}
    .search-row{display:flex;gap:8px;margin-bottom:12px}
    .search-row input{flex:1;padding:12px;border-radius:10px;border:1px solid #e5e7eb}
    .btn{background:var(--accent);color:#fff;padding:10px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:600}
    .btn.ghost{background:transparent;border:1px solid #e5e7eb;color:var(--muted);font-weight:600}
    .btn.success{background:#10b981;}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px}
    .card{background:#fff;padding:12px;border-radius:10px;border:1px solid #e6ecf2}
    .card.clickable{cursor:pointer;transition:transform 0.2s;}
    .card.clickable:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.1);}
    .meta{font-size:13px;color:var(--muted);margin-bottom:8px}
    .contact-info{font-size:14px;color:#374151;margin:8px 0;}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .pill{display:inline-block;padding:6px 8px;border-radius:999px;background:#f1f5f9;font-size:13px;color:var(--muted);text-decoration:none;}
    .pill.primary{background:var(--accent);color:white;}
    .notice{color:var(--muted);padding:8px 0}
    .error{color:#dc2626;}
    .success{color:#10b981;}
    footer{text-align:center;color:var(--muted);padding:16px}
    /* modal simple */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.45);padding:16px;z-index:1000;}
    .modal.show{display:flex}
    .modal-card{width:100%;max-width:720px;background:#fff;border-radius:12px;padding:16px;border:1px solid #e6ecf2;max-height:90vh;overflow-y:auto;}
    label{display:block;font-size:13px;color:#374151;margin-top:8px;font-weight:500;}
    input[type=text], textarea, select{width:100%;padding:10px;border-radius:8px;border:1px solid #e5e7eb;margin-top:6px;font-family:inherit;}
    textarea{min-height:90px;resize:vertical;}
    .service-img{width:100%;height:120px;object-fit:cover;border-radius:8px;margin-bottom:8px;}
    @media(max-width:640px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
<header>
  <h1>Servi√ßo+</h1>
</header>

<main class="container">
  <div class="search-row">
    <input id="q" placeholder="Digite a categoria, nome ou local que procura...">
    <button class="btn" id="searchBtn">Pesquisar</button>
    <button class="btn ghost" id="addBtn">‚ûï Adicionar</button>
  </div>

  <div class="actions">
    <button class="btn ghost" id="catsBtn">üìÇ Ver Categorias</button>
    <button class="btn ghost" id="clearBtn">üßπ Limpar</button>
    <button class="btn ghost" id="testBtn">üîå Testar API</button>
  </div>

  <div id="resultsArea" class="grid" aria-live="polite"></div>
  <div id="emptyNotice" class="notice">Digite acima o que procura (ex: "Restaurante", "Farm√°cia", "Maputo") e clique em Pesquisar.</div>
  <div id="loadingNotice" class="notice" style="display:none">Carregando...</div>
</main>

<footer>Servi√ßo+ ‚Ä¢ Vers√£o 3 ‚Äî feito com ferramentas gr√°tis</footer>

<!-- Modal -->
<div id="modal" class="modal" role="dialog" aria-hidden="true">
  <div class="modal-card">
    <h2>Adicionar Empresa</h2>
    <p style="margin:6px 0 12px;color:#374151">Preencha os dados e clique em Enviar. Campos com * s√£o obrigat√≥rios.</p>

    <label>Nome *</label>
    <input type="text" id="nome" placeholder="Nome da empresa ou profissional">

    <label>Categoria *</label>
    <select id="categoria">
      <option value="">Selecione uma categoria</option>
      <option value="Restaurante">Restaurante</option>
      <option value="Farm√°cia">Farm√°cia</option>
      <option value="√ìptica">√ìptica</option>
      <option value="Mec√¢nica">Mec√¢nica</option>
      <option value="Inform√°tica">Inform√°tica</option>
      <option value="Constru√ß√£o">Constru√ß√£o</option>
      <option value="Sa√∫de">Sa√∫de</option>
      <option value="Educa√ß√£o">Educa√ß√£o</option>
      <option value="Beleza">Beleza</option>
      <option value="Outros">Outros</option>
    </select>

    <label>Localiza√ß√£o</label>
    <input type="text" id="localizacao" placeholder="Bairro, Rua, Cidade">

    <label>Contacto *</label>
    <input type="text" id="contacto" placeholder="ex: 84xxxxxxx">

    <label>WhatsApp</label>
    <input type="text" id="whatsapp" placeholder="apenas n√∫meros (ex: 258841234567)">

    <label>Descri√ß√£o</label>
    <textarea id="descricao" placeholder="Breve descri√ß√£o ou servi√ßos oferecidos"></textarea>

    <label>Foto_URL (opcional)</label>
    <input type="text" id="foto_url" placeholder="URL da imagem">

    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn success" id="submitBtn">Enviar</button>
      <button class="btn ghost" id="cancelBtn">Cancelar</button>
    </div>

    <p id="formMsg" class="notice" style="display:none"></p>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxgCoT3wuGM82z7i4iypCne2OW1TvPYqVLtk_DCBwbbkMumyBDGkgDrba9HyTh5Mc6I/exec";

// Fun√ß√£o de escape para seguran√ßa
function esc(s){ 
  if(!s) return ''; 
  return String(s).replace(/[&<>"']/g, function(m){
    return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
  }); 
}

// Mostrar loading
function showLoading(show) {
  document.getElementById('loadingNotice').style.display = show ? 'block' : 'none';
}

// Buscar todos os dados da API (GET)
async function fetchAll(){ 
  showLoading(true);
  try{ 
    const r = await fetch(API_URL);
    if(!r.ok) throw new Error('HTTP '+r.status); 
    const data = await r.json(); 
    return data || []; 
  }catch(e){ 
    console.error('fetchAll error',e); 
    return null; 
  } finally {
    showLoading(false);
  }
}

// ENVIO SIMPLIFICADO - Vamos testar diferentes abordagens
async function submitData(payload) {
  const msg = document.getElementById('formMsg');
  
  try {
    // M√©todo 1: FormData (mais compat√≠vel com Apps Script)
    const formData = new FormData();
    
    // Adicionar todos os campos ao FormData
    Object.keys(payload).forEach(key => {
      if (payload[key]) {
        formData.append(key, payload[key]);
      }
    });

    // Tentar com FormData primeiro
    console.log('Tentando enviar com FormData:', payload);
    
    const response = await fetch(API_URL, {
      method: 'POST',
      body: formData // N√£o setar Content-Type para FormData
    });

    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    
    const result = await response.json();
    console.log('Resposta do servidor:', result);
    
    return { success: true, data: result };
    
  } catch (error) {
    console.error('Erro no envio:', error);
    
    // M√©todo 2: Tentar com JSON
    try {
      console.log('Tentando com JSON...');
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload)
      });

      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      
      const result = await response.json();
      return { success: true, data: result };
      
    } catch (jsonError) {
      console.error('Erro com JSON tamb√©m:', jsonError);
      return { success: false, error: 'Falha em ambos os m√©todos' };
    }
  }
}

// Renderizar servi√ßos
function renderServices(services) {
  const resultsArea = document.getElementById('resultsArea');
  const emptyNotice = document.getElementById('emptyNotice');
  
  if (!services || services.length === 0) {
    resultsArea.innerHTML = '';
    emptyNotice.textContent = 'Nenhum resultado encontrado. Tente outra pesquisa.';
    emptyNotice.style.display = 'block';
    return;
  }
  
  emptyNotice.style.display = 'none';
  
  resultsArea.innerHTML = services.map(service => `
    <div class="card">
      ${service.Foto_URL ? `<img src="${esc(service.Foto_URL)}" alt="${esc(service.Nome)}" class="service-img" onerror="this.style.display='none'">` : ''}
      <h3>${esc(service.Nome)}</h3>
      <div class="meta">${esc(service.Categoria)} ¬∑ ${esc(service['Localiza√ß√£o'] || 'Local n√£o informado')}</div>
      <div class="contact-info">
        <strong>üìû Contacto:</strong> ${esc(service.Contacto || 'N√£o informado')}
        ${service.WhatsApp ? `<br><strong>üí¨ WhatsApp:</strong> ${esc(service.WhatsApp)}` : ''}
      </div>
      <div style="margin:8px 0">${esc(service.Descri√ß√£o || 'Sem descri√ß√£o')}</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <a class="pill primary" href="tel:${esc(service.Contacto||'')}" onclick="event.stopPropagation()">üìû Ligar</a>
        ${service.WhatsApp ? `<a class="pill" href="https://wa.me/${esc(service.WhatsApp)}" target="_blank" onclick="event.stopPropagation()">üí¨ WhatsApp</a>` : ''}
      </div>
    </div>
  `).join('');
}

// Pesquisar e renderizar
async function searchAndRender(){ 
  const q = document.getElementById('q').value.trim().toLowerCase(); 
  const resultsArea = document.getElementById('resultsArea'); 
  const emptyNotice = document.getElementById('emptyNotice');
  
  resultsArea.innerHTML = ''; 
  
  if(!q){ 
    emptyNotice.textContent = 'Digite acima o que procura (ex: "Restaurante", "Farm√°cia", "Maputo") e clique em Pesquisar.'; 
    emptyNotice.style.display = 'block'; 
    return; 
  } 
  
  const all = await fetchAll(); 
  if(all === null){ 
    resultsArea.innerHTML = '<div class="card error">Erro ao conectar com a API. Verifique a configura√ß√£o.</div>'; 
    return; 
  } 
  
  const filtered = all.filter(item => { 
    return (item.Nome||'').toString().toLowerCase().includes(q) || 
           (item.Categoria||'').toString().toLowerCase().includes(q) || 
           (item['Localiza√ß√£o']||'').toString().toLowerCase().includes(q); 
  }); 
  
  renderServices(filtered);
}

// Fun√ß√£o para pesquisar por categoria (agora clic√°vel)
function searchByCategory(category) {
  document.getElementById('q').value = category;
  searchAndRender();
}

// Mostrar todas as categorias dispon√≠veis
async function showCategories() {
  const all = await fetchAll(); 
  if(all === null){ 
    document.getElementById('resultsArea').innerHTML = '<div class="card error">Erro ao conectar API.</div>'; 
    return; 
  } 
  
  const cats = [...new Set(all.map(x => x.Categoria || 'Outros'))].sort();
  const emptyNotice = document.getElementById('emptyNotice');
  emptyNotice.style.display = 'none';
  
  document.getElementById('resultsArea').innerHTML = cats.map(c => `
    <div class="card clickable" onclick="searchByCategory('${esc(c)}')">
      <strong>${esc(c)}</strong>
      <div class="meta">${all.filter(x => (x.Categoria || 'Outros') === c).length} servi√ßos</div>
      <div style="margin-top:8px;color:var(--accent);font-size:13px">Clique para ver todos os servi√ßos de ${esc(c)}</div>
    </div>
  `).join(''); 
}

// Modal functions
const modal = document.getElementById('modal'); 

document.getElementById('addBtn').addEventListener('click', () => { 
  // Limpar formul√°rio
  document.getElementById('nome').value = '';
  document.getElementById('categoria').value = '';
  document.getElementById('localizacao').value = '';
  document.getElementById('contacto').value = '';
  document.getElementById('whatsapp').value = '';
  document.getElementById('descricao').value = '';
  document.getElementById('foto_url').value = '';
  document.getElementById('formMsg').style.display = 'none';
  
  modal.classList.add('show'); 
  modal.setAttribute('aria-hidden','false'); 
}); 

document.getElementById('cancelBtn').addEventListener('click', () => { 
  modal.classList.remove('show'); 
  modal.setAttribute('aria-hidden','true'); 
  document.getElementById('formMsg').style.display = 'none'; 
}); 

// EVENT LISTENER DO BOT√ÉO ENVIAR - CORRIGIDO
document.getElementById('submitBtn').addEventListener('click', async () => { 
  const nome = document.getElementById('nome').value.trim(); 
  const categoria = document.getElementById('categoria').value.trim(); 
  const localizacao = document.getElementById('localizacao').value.trim(); 
  const contacto = document.getElementById('contacto').value.trim(); 
  const whatsapp = document.getElementById('whatsapp').value.trim(); 
  const descricao = document.getElementById('descricao').value.trim(); 
  const foto_url = document.getElementById('foto_url').value.trim(); 
  const msg = document.getElementById('formMsg'); 
  
  // Valida√ß√µes
  if(!nome || !categoria || !contacto){ 
    msg.style.display='block'; 
    msg.textContent='Por favor preencha Nome, Categoria e Contacto.'; 
    msg.className = 'notice error';
    return; 
  }
  
  msg.style.display='block'; 
  msg.textContent='Enviando...'; 
  msg.className = 'notice';
  
  // Preparar payload - TESTAR DIFERENTES FORMATOS
  const payload = {
    // Tentar com nomes em portugu√™s (como na planilha)
    'Nome': nome,
    'Categoria': categoria, 
    'Localiza√ß√£o': localizacao,
    'Contacto': contacto,
    'WhatsApp': whatsapp,
    'Descri√ß√£o': descricao,
    'Foto_URL': foto_url,
    
    // Tamb√©m incluir em min√∫sculas para garantir
    'nome': nome,
    'categoria': categoria,
    'localizacao': localizacao,
    'contacto': contacto,
    'whatsapp': whatsapp,
    'descricao': descricao,
    'foto_url': foto_url
  };
  
  console.log('Payload sendo enviado:', payload);
  
  const result = await submitData(payload);
  
  if (result.success) {
    msg.textContent = '‚úÖ Enviado com sucesso!'; 
    msg.className = 'notice success';
    
    // Limpar formul√°rio ap√≥s sucesso
    document.getElementById('nome').value = '';
    document.getElementById('categoria').value = '';
    document.getElementById('localizacao').value = '';
    document.getElementById('contacto').value = '';
    document.getElementById('whatsapp').value = '';
    document.getElementById('descricao').value = '';
    document.getElementById('foto_url').value = '';
    
    setTimeout(() => { 
      modal.classList.remove('show'); 
      msg.style.display = 'none'; 
      // Recarregar os dados
      if (document.getElementById('q').value) {
        searchAndRender();
      }
    }, 2000); 
  } else {
    msg.innerHTML = '‚ùå Falha ao enviar. <br><small>Verifique o console (F12) para detalhes.</small>'; 
    msg.className = 'notice error';
  }
}); 

// Event Listeners
document.getElementById('searchBtn').addEventListener('click', searchAndRender); 
document.getElementById('q').addEventListener('keydown', function(e){ 
  if(e.key === 'Enter') searchAndRender(); 
}); 

document.getElementById('clearBtn').addEventListener('click', () => { 
  document.getElementById('resultsArea').innerHTML = ''; 
  document.getElementById('q').value = ''; 
  document.getElementById('emptyNotice').textContent = 'Digite acima o que procura (ex: "Restaurante", "Farm√°cia", "Maputo") e clique em Pesquisar.';
  document.getElementById('emptyNotice').style.display = 'block'; 
}); 

document.getElementById('catsBtn').addEventListener('click', showCategories);

document.getElementById('testBtn').addEventListener('click', async () => { 
  try{ 
    const r = await fetch(API_URL); 
    if(r.ok) {
      const data = await r.json();
      alert(`‚úÖ API GET funcionando!\nEncontrados ${data.length} registros.`); 
    } else {
      alert('‚ùå API retornou status '+r.status); 
    }
  }catch(e){ 
    alert('‚ùå Erro ao conectar com API: ' + e.message); 
  } 
}); 

// N√£o carrega automaticamente - s√≥ ap√≥s pesquisa
</script>
</body>
</html>
